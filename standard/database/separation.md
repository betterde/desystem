# 读写分离

当主库(Master)的数据发生变化的时候，变化会实时的同步到从(Slave)库。在Master机器上，主从同步事件会被写到特殊的log文件中(binary-log)。从库生成两个线程，一个I/O线程，一个SQL线程。I/O线程去请求主库的binary-log，并将得到的binary-log日志写到relay log（中继日志）文件中；主库会生成一个 log dump 线程，用来给从库 I/O线程传binary-log。SQL线程，会读取relay log文件中的日志，并解析成具体操作，来实现主从的操作一致，而最终数据一致；

## 名词解释

### Binary-log
的二进制日志也叫作变更日志，主要用于记录修改数据或有可能引起数据改变的SQL语句，并且记录了语句发生时间、执行时长、操作的数据等等。所以说通过二进制日志可以查询MySQL数据库中进行了哪些变化。一般大小体积上限为1G。

### 日志模式

#### Row Level 模式

日志中会记录成每一行数据修改的形式，然后在slave端再对相同的数据进行修改。

优点：在row level的模式下，binary-log中可以不记录执行的sql语句的上下文信息，仅仅只需要记录哪一条记录被修改，修改成什么样。所以row level的日志内容会非常清楚的记录每一行数据修改的细节，非常容易理解。而且不会出现某些特定情况下的存储过程，或fuction，以及trigger的调用或处罚无法被正确复制的问题。

缺点：所有的执行语句都会记录到日志中，同时都会以每行记录修改的来记录，这样可能会产生大量的日志内容。

#### Statement Level 模式

每一条修改数据的sql都会记录到master的bin_log中，slave在复制的时候sql进程会解析成master端执行过的相同的sql在slave库上再次执行。

优点：statement level下的优点首先就是解决了row level下的缺点，不需要记录每一行的变化，较少bin-log日志量，节约IO，提高性能。因为它只需要记录在master上所执行的语句的细节，以及执行语句时候的上下文信息。

缺点：由于它是记录执行语句，所以，为了让这些语句在slave端也能正确执行，那么它还必须记录每条语句在执行的时候的一些相关信息，也就是上下文信息，来保证所有语句在slave端能够得到和在master端相同的执行结果。由于MySQL更新较快，使MySQL的赋值遇到了不小的挑战，自然赋值的时候就会涉及到越复杂的内容，bug也就容易出现。在statement level下，目前就已经发现了不少情况会造成MySQL的复制出现问题，主要是修改数据的时候使用了某些特定的函数或者功能的时候会出现。

#### Mixed 模式

实际上就是前两种模式的结合，在mixed模式下，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也是在statement和row之间选择一种。

新版本中的MySQL中对row level模式也做了优化，并不是所有的修改都会以row level来记录，像遇到表结构变更的时候就会以statement模式来记录，如果sql语句确实就是update或者delete等修改数据的语句，那么还是会记录所有行的变更。

::: tip 如何选择日志模式
推荐使用混合模式来进行主从同步
:::

## 注意事项

1. 主从版本一定要一致；
2. 在主库中创建一个拥有复制权限的用户，当然也可以直接用`root`用户；
3. 启用同步前，要保证主从数据一致；
4. 设置binlog的过期时间，以防日志文件占用过的的磁盘空间。

## 具体实现

### 创建账户

```sql
# MySQL 5.7 及以前版本
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'USER-NAME'@'HOST-IP' IDENTIFIED BY 'PASSWORD';

# MySQL 8.*

```

### 导出主库

这里将需要同步的数据库进行全量导出，并记录日志版本
